name: Train and Inference YOLOv11 Model

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  install:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.10'

      - name: Upgrade setuptools and wheel
        run: |
          pip install --upgrade setuptools wheel

      - name: Install build tools
        run: sudo apt-get install -y build-essential  # 安装构建工具

      - name: Install dependencies without cache
        run: |
          pip install --no-cache-dir -r requirements.txt  # 强制重新安装所有依赖

      - name: Install YOLOv5 from GitHub
        run: |
          pip install --no-cache-dir git+https://github.com/ultralytics/yolov5.git  # 安装 YOLOv5

      - name: Check if yolo is installed
        run: |
          python -m pip show ultralytics  # 查看 ultralytics 包是否安装
          which yolo  # 查找 `yolo` 命令的路径
          python -m yolo --help  # 确认 `yolo` 命令是否有效

      - name: Check dataset directories
        run: |
          echo "Checking if data directories exist..."
          ls -al ./mydata/images/train
          ls -al ./mydata/images/val
          ls -al ./mydata/images/test

  train:
    runs-on: ubuntu-latest
    needs: install  # 确保安装步骤完成后再运行训练步骤

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Update Ultralytics settings
        run: |
          python -m yolo settings dataset_dir=./mydata/images  # 使用 python -m yolo 调用命令

      - name: Train YOLOv11 Model
        run: |
          python train.py --img 640 --batch-size 16 --epochs 50 --data data.yaml --cfg yolov11.yaml --nc 5 --weights yolov11n.pt --name my_yolov11_model

      - name: Upload training results
        uses: actions/upload-artifact@v4
        with:
          name: training-results
          path: runs/train/my_yolov11_model/

  inference:
    runs-on: ubuntu-latest
    needs: train  # 确保训练步骤完成后再运行推理步骤

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Run inference
        run: |
          python detect.py --weights runs/train/my_yolov11_model/weights/best.pt --img 640 --source mydata/test/images --save-txt --save-img --project runs/inference --name inference_results

      - name: Upload inference results
        uses: actions/upload-artifact@v4
        with:
          name: inference-results
          path: runs/inference/inference_results/
